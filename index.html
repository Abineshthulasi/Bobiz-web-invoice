<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Billing / Invoice — Public Storage</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--accent:#0ea5a4;--muted:#6b7280}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Arial}
    body{margin:0;background:var(--bg);color:#0f172a}
    header{background:linear-gradient(90deg,#06b6d4, #7dd3fc);padding:18px;color:white}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    h2{margin:0 0 10px 0}
    label{display:block;margin:8px 0 4px;font-size:13px;color:var(--muted)}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px dashed #eef2f7;text-align:left}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .invoice{padding:18px}
    .row{display:flex;gap:8px}
    .flex{display:flex;gap:8px}
    .right{text-align:right}
    .small{font-size:13px;color:var(--muted)}
    .product-list{max-height:180px;overflow:auto}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center}
    .modal .sheet{width:420px;background:white;border-radius:10px;padding:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.container{padding:8px}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0;font-size:20px">Billing / Invoice — Public Storage</h1>
      <div class="small">You can save invoices locally or publish them publicly to Firestore.</div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card" id="leftPanel">
        <h2>Customer & Products</h2>

        <label>Customer Name</label>
        <input id="customerName" placeholder="Enter customer name" />
        <label>Mobile Number</label>
        <input id="customerMobile" placeholder="10-digit mobile" />
        <div class="small" style="margin-bottom:8px">When you save an invoice it will be stored locally; enable Public to also publish it online.</div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
          <input id="search" placeholder="Search products..." style="flex:1;padding:8px;border:1px solid #e6e9ef;border-radius:8px"/>
          <button class="btn" id="btnAddProduct">+ Add product</button>
        </div>

        <div class="card product-list" id="productCatalog"></div>

        <h3 style="margin-top:12px">Cart</h3>
        <table id="cartTable">
          <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th class="right">Total</th><th></th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="muted">Invoice No.: <strong id="invoiceNo"></strong></div>
          <div class="actions">
            <button class="btn" id="btnClear">Clear</button>
            <button class="btn" id="btnPrint">Print / Save PDF</button>
            <button class="btn" id="btnExport">Export JSON</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Advance Payment (₹):</label>
          <input id="advanceInput" type="number" min="0" value="0" />
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="btnSaveLocal">Save Invoice (Local)</button>
          <button class="btn" id="publishBtn">Save & Publish (Public)</button>
          <button class="btn" id="btnHistory">Open History</button>
        </div>

        <div style="margin-top:8px" class="small">Public invoices will be visible to anyone who visits the site. Do not publish sensitive info.</div>

      </div>

      <div class="card" id="rightPanel">
        <h2>Invoice Preview</h2>
        <div class="invoice" id="invoicePreview">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Your Shop Name</h3>
              <div class="small">Address line 1<br/>City, State</div>
            </div>
            <div class="right small">
              <div>Invoice: <strong id="previewInv"></strong></div>
              <div>Date: <span id="previewDate"></span></div>
              <div class="small">Customer: <span id="previewCustomer"></span></div>
            </div>
          </div>

          <hr style="margin:12px 0">
          <div id="lineItems"></div>

          <div style="display:flex;justify-content:flex-end;margin-top:12px">
            <div style="width:360px">
              <div class="row small"><div style="flex:1">Sub total</div><div id="subTotal" style="width:120px;text-align:right"></div></div>
              <div class="row small"><div style="flex:1">Discount</div><div id="discountVal" style="width:120px;text-align:right">0.00</div></div>
              <div class="row small"><div style="flex:1">Tax</div><div id="taxVal" style="width:120px;text-align:right">0.00</div></div>
              <div class="row small"><div style="flex:1">Total</div><div id="totalVal" style="width:120px;text-align:right"></div></div>
              <div class="row small"><div style="flex:1">Advance Paid</div><div id="advanceVal" style="width:120px;text-align:right">0.00</div></div>
              <div style="height:8px"></div>
              <div class="row" style="font-weight:700;font-size:18px"><div style="flex:1">Balance Due</div><div id="balanceVal" style="width:120px;text-align:right"></div></div>
            </div>
          </div>
        </div>

        <hr>
        <h3>Settings</h3>
        <label>Discount (₹ or %):</label>
        <div style="display:flex;gap:8px"><input id="discount" placeholder="0"/><select id="discountType"><option value="flat">₹ Flat</option><option value="percent">% Percent</option></select></div>
        <label>Tax (%):</label>
        <input id="tax" value="0"/>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="btnApply">Apply</button>
          <button class="btn" id="btnNewInv">New Invoice No.</button>
        </div>

        <div style="margin-top:12px" class="small">Tip: change advance in the left panel or edit it here and click Apply — balance updates automatically.</div>
      </div>
    </div>

    <!-- Public invoices list (below the grid) -->
    <div style="margin-top:18px">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Public Invoices (Anyone can view)</h3>
        <div class="small">This section lists invoices that have been published. It reads from the configured online database.</div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="publicSearch" placeholder="Search public invoices by mobile or invoice no" style="flex:1;padding:8px;border:1px solid #e6e9ef;border-radius:8px"/>
          <button class="btn" id="btnPublicRefresh">Refresh</button>
        </div>
        <div id="publicList" style="margin-top:12px;max-height:360px;overflow:auto"></div>
      </div>
    </div>

  </div>

  <!-- Add product modal -->
  <div id="modal" class="modal"><div class="sheet">
    <h3 style="margin-top:0">Add Product</h3>
    <label>Name</label><input id="p_name" />
    <label>Price</label><input id="p_price" type="number" />
    <label>SKU (optional)</label><input id="p_sku" />
    <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
      <button class="btn" id="btnModalCancel">Cancel</button>
      <button class="btn" id="btnModalSave">Save</button>
    </div>
  </div></div>

  <!-- History modal -->
  <div id="historyModal" class="modal" style="align-items:flex-start;padding-top:40px;overflow:auto"><div class="sheet" style="width:920px;max-width:96%">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Invoice History</h3>
        <div><button class="btn" id="btnCloseHistory">Close</button></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="historyMobile" placeholder="Search by mobile number" />
        <input id="historyInvoiceNo" placeholder="Search by invoice no" />
        <button class="btn" id="btnSearchHistory">Search</button>
        <button class="btn" id="btnListAll">List All</button>
        <div class="small" style="margin-left:auto">Data stored locally in your browser (localStorage) — and optionally published to your online database.</div>
      </div>

      <div id="historyResults" style="margin-top:12px;max-height:520px;overflow:auto"></div>
  </div></div>

  <!-- Firebase SDKs (compat build) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
/* ====== Firebase config (your config inserted) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDbgBrXOpset_I_RLWgyxoiMEeM6AYPG6E",
  authDomain: "invoice--web.firebaseapp.com",
  projectId: "invoice--web",
  storageBucket: "invoice--web.firebasestorage.app",
  messagingSenderId: "696864322584",
  appId: "1:696864322584:web:10b2f8064e8fba5834ff6d",
  measurementId: "G-56EKJC17LK"
};

let firestore = null;
try{ firebase.initializeApp(firebaseConfig); firestore = firebase.firestore(); console.log('Firebase ready'); }catch(e){ console.warn('Firebase init failed', e); }

/* ===== App code (full) ===== */
let products = [
  {id:1,name:'Product A',price:199.00,sku:'A001'},
  {id:2,name:'Product B',price:349.00,sku:'B001'},
  {id:3,name:'Service X',price:499.00,sku:'S100'}
];
let cart = [];
let settings = {discount:0,discountType:'flat',tax:0,advance:0};

const $ = id => document.getElementById(id);
function format(v){ return '₹ '+Number(v||0).toFixed(2); }

function renderCatalog(filter=''){
  const el = $('productCatalog'); el.innerHTML = '';
  const list = products.filter(p => (p.name||'').toLowerCase().includes(filter.toLowerCase()) || (p.sku||'').toLowerCase().includes(filter.toLowerCase()));
  list.forEach(p => {
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.name}</strong><div class='small'>${format(p.price)}${p.sku?(' • '+p.sku):''}</div>`;
    const right = document.createElement('div'); const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Add'; btn.addEventListener('click', ()=>addToCart(p.id)); right.appendChild(btn);
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.appendChild(left); row.appendChild(right);
    d.appendChild(row); el.appendChild(d);
  });
}

function renderCart(){
  const tbody = $('cartTable').querySelector('tbody'); tbody.innerHTML='';
  cart.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.textContent = it.name;
    const tdQty = document.createElement('td'); const q = document.createElement('input'); q.type='number'; q.min=1; q.value=it.qty; q.style.width='72px'; q.addEventListener('change', (e)=>{ updateQty(idx, e.target.value); }); tdQty.appendChild(q);
    const tdPrice = document.createElement('td'); tdPrice.textContent = format(it.price);
    const tdTotal = document.createElement('td'); tdTotal.className='right'; tdTotal.textContent = format(it.price*it.qty);
    const tdAction = document.createElement('td'); const rb = document.createElement('button'); rb.className='btn'; rb.textContent='Remove'; rb.addEventListener('click', ()=>removeItem(idx)); tdAction.appendChild(rb);
    tr.appendChild(tdName); tr.appendChild(tdQty); tr.appendChild(tdPrice); tr.appendChild(tdTotal); tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });
  renderPreview();
}

function addToCart(id){ const p = products.find(x=>x.id===id); if(!p) return; const ex = cart.find(x=>x.id===id); if(ex) ex.qty+=1; else cart.push({...p,qty:1}); renderCart(); }
function updateQty(i,val){ cart[i].qty = Math.max(1, Number(val)); renderCart(); }
function removeItem(i){ cart.splice(i,1); renderCart(); }
function clearCart(){ cart=[]; renderCart(); }

function computeTotals(){
  let subtotal = 0; cart.forEach(it=> subtotal += it.price*it.qty);
  let discount = Number(settings.discount)||0; if(settings.discountType==='percent') discount = subtotal*(discount/100);
  let taxable = subtotal - discount; let tax = taxable * ((Number(settings.tax)||0)/100);
  const total = subtotal - discount + tax; const advance = Number(settings.advance)||0; let balance = total - advance; if(balance<0) balance=0;
  return {subtotal,discount,tax,total,advance,balance};
}

function renderPreview(){
  $('previewDate').innerText = new Date().toLocaleString();
  $('previewInv').innerText = $('invoiceNo').innerText || '';
  const customer = $('customerName').value.trim() + ($('customerMobile').value.trim() ? (' • ' + $('customerMobile').value.trim()) : '');
  $('previewCustomer').innerText = customer || '-';
  const li = $('lineItems'); li.innerHTML = '';
  cart.forEach(it=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
    row.innerHTML = `<div><strong>${it.name}</strong><div class='small'>Qty: ${it.qty} • ${format(it.price)}</div></div><div>${format(it.price*it.qty)}</div>`;
    li.appendChild(row);
  });
  const t = computeTotals();
  $('subTotal').innerText = format(t.subtotal);
  $('discountVal').innerText = format(t.discount);
  $('taxVal').innerText = format(t.tax);
  $('totalVal').innerText = format(t.total);
  $('advanceVal').innerText = format(t.advance);
  $('balanceVal').innerText = format(t.balance);
}

/* Local storage helpers */
function loadInvoices(){ try{ return JSON.parse(localStorage.getItem('invoices_v1')||'[]'); }catch(e){ return []; } }
function saveInvoices(arr){ localStorage.setItem('invoices_v1', JSON.stringify(arr)); }
function loadCustomers(){ try{ return JSON.parse(localStorage.getItem('customers_v1')||'{}'); }catch(e){ return {}; } }
function saveCustomers(obj){ localStorage.setItem('customers_v1', JSON.stringify(obj)); }

function saveInvoice(){
  const mobile = $('customerMobile').value.trim(); const name = $('customerName').value.trim();
  if(!mobile){ if(!confirm('Save without customer mobile? This invoice will not be associated with a customer. Continue?')) return; }
  const invNo = $('invoiceNo').innerText || ('INV'+Date.now().toString().slice(-8));
  const t = computeTotals();
  const record = { invoiceNo: invNo, date: new Date().toISOString(), customer:{name,mobile}, products: cart.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku})), settings:{...settings, discount:Number(settings.discount)||0, tax:Number(settings.tax)||0, advance:Number(settings.advance)||0}, totals:t };
  let arr = loadInvoices(); const idx = arr.findIndex(x=>x.invoiceNo===invNo); if(idx>=0) arr[idx]=record; else arr.unshift(record); saveInvoices(arr);
  if(mobile){ const c = loadCustomers(); c[mobile] = {name,mobile,lastInvoice:invNo,lastSeen:new Date().toISOString()}; saveCustomers(c); }
  alert('Invoice saved locally.');
}

/* History */
function openHistory(){ $('historyModal').style.display='flex'; listAllHistory(); }
function closeHistory(){ $('historyModal').style.display='none'; }
function listAllHistory(){ renderHistoryResults(loadInvoices()); }
function searchHistory(){ const mobile=$('historyMobile').value.trim(); const inv=$('historyInvoiceNo').value.trim(); let res=loadInvoices(); if(mobile) res=res.filter(r=>r.customer&&r.customer.mobile&&r.customer.mobile.includes(mobile)); if(inv) res=res.filter(r=>r.invoiceNo&&r.invoiceNo.includes(inv)); renderHistoryResults(res); }
function renderHistoryResults(results){ const el=$('historyResults'); el.innerHTML=''; if(!results.length){ el.innerHTML='<div class=\"small\">No invoices found.</div>'; return; } results.forEach(r=>{ const d=document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9'; d.innerHTML = `<div style=\"display:flex;justify-content:space-between;align-items:center\"><div><strong>${r.invoiceNo}</strong> <span class='small'>• ${new Date(r.date).toLocaleString()}</span><div class='small'>${r.customer&&r.customer.name? r.customer.name+' • '+r.customer.mobile : 'No customer'}</div></div><div style='display:flex;gap:8px'><button class='btn' data-inv='${r.invoiceNo}' data-action='load'>Load</button><button class='btn' data-inv='${r.invoiceNo}' data-action='download'>Download</button><button class='btn' data-inv='${r.invoiceNo}' data-action='delete'>Delete</button></div></div>`; el.appendChild(d); }); }

/* Delegated history actions */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-action]');
  if(!b) return;
  const inv = b.dataset.inv; const action = b.dataset.action;
  if(action==='load') loadInvoice(inv);
  if(action==='download') downloadInvoice(inv);
  if(action==='delete') deleteInvoice(inv);
});

/* Load / Download / Delete */
function loadInvoice(invNo){ const arr = loadInvoices(); const r = arr.find(x=>x.invoiceNo===invNo); if(!r){ alert('Invoice not found'); return; } cart = r.products.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku})); settings.discount=r.settings.discount||0; settings.discountType=r.settings.discountType||'flat'; settings.tax=r.settings.tax||0; settings.advance=r.settings.advance||0; $('discount').value=settings.discount; $('discountType').value=settings.discountType; $('tax').value=settings.tax; $('advanceInput').value=settings.advance; $('customerName').value=r.customer?.name||''; $('customerMobile').value=r.customer?.mobile||''; $('invoiceNo').innerText=r.invoiceNo; renderCart(); closeHistory(); alert('Invoice loaded into editor.'); }
function downloadInvoice(invNo){ const arr=loadInvoices(); const r=arr.find(x=>x.invoiceNo===invNo); if(!r) return alert('Not found'); const blob=new Blob([JSON.stringify(r,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`invoice-${invNo}.json`; a.click(); }
function deleteInvoice(invNo){ if(!confirm('Delete invoice '+invNo+'? This cannot be undone.')) return; let arr=loadInvoices(); arr=arr.filter(x=>x.invoiceNo!==invNo); saveInvoices(arr); listAllHistory(); }

/* Publish */
async function saveAndPublish(){
  saveInvoice();
  if(!firestore){ alert('Firebase not configured. Configure firebaseConfig in the file to publish online.'); return; }
  const invNo = $('invoiceNo').innerText || ('INV'+Date.now().toString().slice(-8));
  const doc = { invoiceNo: invNo, date: new Date().toISOString(), customer:{name:$('customerName').value.trim(), mobile:$('customerMobile').value.trim()}, products: cart.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku})), settings:{...settings, discount:Number(settings.discount)||0, tax:Number(settings.tax)||0, advance:Number(settings.advance)||0}, totals: computeTotals(), publishedAt: new Date().toISOString() };
  try{ await firestore.collection('public_invoices').doc(invNo).set(doc); alert('Invoice published publicly.'); loadPublicInvoices(); }catch(e){ console.error(e); alert('Publish failed: '+e.message); }
}

async function loadPublicInvoices(){
  const container=$('publicList'); container.innerHTML='<div class="small">Loading...</div>';
  if(!firestore){ container.innerHTML='<div class="small">Firebase not configured — public invoices unavailable.</div>'; return;}
  try{
    const snapshot = await firestore.collection('public_invoices').orderBy('publishedAt','desc').limit(200).get();
    const q = $('publicSearch').value.trim().toLowerCase();
    const list = [];
    snapshot.forEach(doc=>{ const data=doc.data(); if(!q|| (data.customer&&data.customer.mobile&&data.customer.mobile.includes(q)) || (data.invoiceNo&&data.invoiceNo.toLowerCase().includes(q))) list.push(data); });
    if(!list.length){ container.innerHTML='<div class="small">No public invoices found.</div>'; return;}
    container.innerHTML='';
    list.forEach(r=>{
      const d=document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
      d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${r.invoiceNo}</strong> <span class='small'>• ${new Date(r.date).toLocaleString()}</span><div class='small'>${r.customer&&r.customer.name? r.customer.name+' • '+r.customer.mobile : 'No customer'}</div></div><div style='display:flex;gap:8px'><button class='btn' data-inv='${r.invoiceNo}' data-action='viewPublic'>View</button></div></div>`;
      container.appendChild(d);
    });
  }catch(e){ console.error(e); container.innerHTML='<div class="small">Error loading public invoices: '+e.message+'</div>'; }
}

/* View public invoice (delegated) */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-action="viewPublic"]');
  if(!b) return;
  const inv = b.dataset.inv; viewPublicInvoice(inv);
});

async function viewPublicInvoice(invNo){
  if(!firestore){ alert('Firebase not configured'); return; }
  try{
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if(!doc.exists){ alert('Not found'); return; }
    const r = doc.data();
    const w = window.open('','_blank');
    const content = `
      <div style="font-family:Inter,Arial;max-width:700px;margin:20px auto;padding:12px;border:1px solid #eee">
        <h2>${r.invoiceNo}</h2>
        <div>${r.customer && r.customer.name ? r.customer.name : ''} ${r.customer && r.customer.mobile ? ' • ' + r.customer.mobile : ''}</div>
        <hr/>
        <div>` + r.products.map(p=>`<div style='display:flex;justify-content:space-between'><div>${p.name} x ${p.qty}</div><div>₹ ${(p.price*p.qty).toFixed(2)}</div></div>`).join('') + `</div>
        <hr/>
        <div style='text-align:right'><div>Subtotal: ₹ ${r.totals.subtotal.toFixed(2)}</div><div>Tax: ₹ ${r.totals.tax.toFixed(2)}</div><div style='font-weight:700'>Total: ₹ ${r.totals.total.toFixed(2)}</div></div>
      </div>
    `;
    w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>${invNo}</title></head><body>${content}
<!-- Enhancement script: product edit/delete, public invoice actions, mobile popup fallback -->
<script>
// --- Persistence for products ---
function loadProductsFromStorage(){
  try{
    const raw = localStorage.getItem('products_v1');
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length) {
        products = arr.map(p=>({id:p.id,name:p.name,price:p.price,sku:p.sku}));
      }
    }
  }catch(e){ console.warn('loadProducts error', e); }
}
function saveProductsToStorage(){
  try{ localStorage.setItem('products_v1', JSON.stringify(products)); }catch(e){console.warn('saveProducts error', e);}
}

// Override renderCatalog to include Edit/Delete buttons for products
function renderCatalog(filter=''){
  const el = document.getElementById('productCatalog'); el.innerHTML = '';
  const q = (filter||'').toLowerCase();
  const list = products.filter(p => (p.name||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));
  list.forEach(p => {
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.name}</strong><div class='small'>₹ ${Number(p.price||0).toFixed(2)}${p.sku?(' • '+p.sku):''}</div>`;
    const right = document.createElement('div');
    // Add, Edit, Delete buttons
    const btnAdd = document.createElement('button'); btnAdd.className='btn'; btnAdd.textContent='Add'; btnAdd.addEventListener('click', ()=>addToCart(p.id));
    const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.style.background='#f59e0b'; btnEdit.textContent='Edit'; btnEdit.addEventListener('click', ()=>openEditProductModal(p.id));
    const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.style.background='#ef4444'; btnDel.textContent='Delete'; btnDel.addEventListener('click', ()=>deleteProduct(p.id));
    // layout
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='6px'; wrap.appendChild(btnAdd); wrap.appendChild(btnEdit); wrap.appendChild(btnDel);
    right.appendChild(wrap);
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.appendChild(left); row.appendChild(right);
    d.appendChild(row); el.appendChild(d);
  });
}

// Product edit modal support: reuse the existing modal but indicate edit mode
let editingProductId = null;
function openEditProductModal(id){
  const p = products.find(x=>x.id===id); if(!p) return alert('Product not found');
  editingProductId = id;
  document.getElementById('p_name').value = p.name;
  document.getElementById('p_price').value = p.price;
  document.getElementById('p_sku').value = p.sku||'';
  document.getElementById('modal').style.display='flex';
}
function saveProductFromModalEnhanced(){
  const name = document.getElementById('p_name').value.trim();
  const price = Number(document.getElementById('p_price').value)||0;
  const sku = document.getElementById('p_sku').value.trim();
  if(!name || price<=0){ alert('Enter product name and price > 0'); return; }
  if(editingProductId){
    const p = products.find(x=>x.id===editingProductId);
    if(p){ p.name = name; p.price = price; p.sku = sku; }
    editingProductId = null;
  } else {
    const id = products.length? (Math.max(...products.map(p=>p.id))+1):1;
    products.push({id,name,price,sku});
  }
  saveProductsToStorage();
  closeAddProductModal();
  renderCatalog();
}

// delete product
function deleteProduct(id){
  if(!confirm('Delete product? This will remove it from the catalog.')) return;
  products = products.filter(p=>p.id!==id);
  saveProductsToStorage();
  renderCatalog();
}

// --- Mobile-friendly window open fallback ---
function openWindowWithContent(html, filenameForBlob = null) {
  try {
    const w = window.open('', '_blank');
    if (w && w.document) {
      w.document.open();
      w.document.write(html);
      w.document.close();
      return w;
    }
  } catch (e) {
    console.warn('window.open failed, falling back to blob:', e);
  }
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  if (filenameForBlob) a.download = filenameForBlob;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 10000);
  return null;
}

// --- Public invoices: view/edit/delete/pdf/csv ---
async function loadPublicInvoicesEnhanced(){
  const container = document.getElementById('publicList'); container.innerHTML = '<div class="small">Loading...</div>';
  if (!firestore) { container.innerHTML = '<div class="small">Firebase not configured — public invoices unavailable.</div>'; return; }
  try {
    const snapshot = await firestore.collection('public_invoices').orderBy('publishedAt','desc').limit(200).get();
    const q = document.getElementById('publicSearch').value.trim().toLowerCase();
    const list = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (!q || (data.customer && data.customer.mobile && data.customer.mobile.includes(q)) || (data.invoiceNo && data.invoiceNo.toLowerCase().includes(q))) list.push(data);
    });
    if (!list.length) { container.innerHTML = '<div class="small">No public invoices found.</div>'; return; }
    container.innerHTML = '';
    list.forEach(r => {
      const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${r.invoiceNo}</strong> <span class='small'>• ${new Date(r.date).toLocaleString()}</span>
            <div class='small'>${r.customer && r.customer.name ? r.customer.name+' • '+r.customer.mobile : 'No customer'}</div>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='viewPublic'>View</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='editPublic'>Edit</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='deletePublic'>Delete</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='pdfPublic'>PDF</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='csvPublic'>Excel</button>
          </div>
        </div>`;
      container.appendChild(d);
    });
  } catch (e) {
    console.error(e); container.innerHTML = '<div class="small">Error loading public invoices: '+e.message+'</div>';
  }
}

async function viewPublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const html = renderPrintableHtmlForInvoice(r);
    const w = openWindowWithContent(html);
    if (w && w.document) {
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e) { console.warn('print failed', e); } }, 250);
    } else {
      alert('Invoice opened. Use your browser menu -> Print -> Save as PDF to create a PDF.');
    }
  } catch (e) { alert('Error: ' + e.message); }
}

async function editPublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    cart = r.products.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku}));
    settings.discount = r.settings?.discount || 0;
    settings.discountType = r.settings?.discountType || 'flat';
    settings.tax = r.settings?.tax || 0;
    settings.advance = r.settings?.advance || 0;
    document.getElementById('discount').value = settings.discount; document.getElementById('discountType').value = settings.discountType; document.getElementById('tax').value = settings.tax;
    document.getElementById('advanceInput').value = settings.advance;
    document.getElementById('customerName').value = r.customer?.name || '';
    document.getElementById('customerMobile').value = r.customer?.mobile || '';
    document.getElementById('invoiceNo').innerText = r.invoiceNo;
    renderCart();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    alert('Public invoice loaded into editor. Make changes and Save & Publish to overwrite (if your rules allow).');
  } catch (e) { alert('Error: ' + e.message); }
}

async function deletePublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  if (!confirm('Delete public invoice '+invNo+'? This removes it from the public list.')) return;
  try {
    await firestore.collection('public_invoices').doc(invNo).delete();
    alert('Public invoice deleted.');
    loadPublicInvoicesEnhanced();
  } catch (e) { alert('Delete failed: '+e.message); }
}

async function downloadPublicPDFEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const html = renderPrintableHtmlForInvoice(r);
    const w = openWindowWithContent(html, `invoice-${invNo}.html`);
    if (w && w.document) {
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e){ console.warn(e); } }, 300);
    } else {
      alert('Invoice opened. Use your browser menu -> Print -> Save as PDF to create a PDF.');
    }
  } catch (e) { alert('Error: '+e.message); }
}

async function downloadPublicCSVEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const rows = [];
    rows.push(['Invoice', r.invoiceNo]);
    rows.push(['Date', new Date(r.date).toLocaleString()]);
    rows.push(['Customer', r.customer?.name || '', 'Mobile', r.customer?.mobile || '']);
    rows.push([]);
    rows.push(['Item','Qty','Unit Price','Total']);
    r.products.forEach(p => { rows.push([p.name, p.qty, p.price.toFixed(2), (p.price * p.qty).toFixed(2)]); });
    rows.push([]);
    const totals = r.totals || {};
    rows.push(['Subtotal', totals.subtotal?.toFixed(2) || '0.00']);
    rows.push(['Tax', totals.tax?.toFixed(2) || '0.00']);
    rows.push(['Total', totals.total?.toFixed(2) || '0.00']);
    rows.push(['Advance', totals.advance?.toFixed(2) || '0.00']);
    rows.push(['Balance', totals.balance?.toFixed(2) || '0.00']);
    const csv = rows.map(rw => rw.map(cell => { if (cell === null || cell === undefined) return ''; const s = String(cell).replace(/"/g, '""'); return `"${s}"`; }).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `invoice-${invNo}.csv`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),10000);
  } catch (e) { alert('Error: '+e.message); }
}

// helper to produce printable HTML for an invoice object (reused)
function renderPrintableHtmlForInvoice(r) {
  const itemsHtml = (r.products || []).map(p => `<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${p.name} x ${p.qty}</div><div>₹ ${(p.price*p.qty).toFixed(2)}</div></div>`).join('');
  const totals = r.totals || {};
  return `<!doctype html><html><head><meta charset="utf-8"><title>${r.invoiceNo}</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:12px}h2{margin:0 0 8px} .small{color:#666;font-size:13px}</style>
    </head><body>
    <h2>Invoice: ${r.invoiceNo}</h2>
    <div class="small">${new Date(r.date).toLocaleString()}</div>
    <div style="margin-top:8px">${r.customer?.name || ''} ${r.customer?.mobile ? ' • ' + r.customer.mobile : ''}</div>
    <hr/>
    ${itemsHtml}
    <hr/>
    <div style="text-align:right">
      <div>Subtotal: ₹ ${(totals.subtotal||0).toFixed(2)}</div>
      <div>Tax: ₹ ${(totals.tax||0).toFixed(2)}</div>
      <div style="font-weight:700">Total: ₹ ${(totals.total||0).toFixed(2)}</div>
      <div>Advance: ₹ ${(totals.advance||0).toFixed(2)}</div>
      <div style="font-size:18px;margin-top:6px">Balance: ₹ ${(totals.balance||0).toFixed(2)}</div>
    </div>
    </body></html>`;
}

// Delegated public action handler
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const inv = btn.dataset.inv; const act = btn.dataset.action;
  if(act==='viewPublic') viewPublicInvoiceEnhanced(inv);
  else if(act==='editPublic') editPublicInvoiceEnhanced(inv);
  else if(act==='deletePublic') deletePublicInvoiceEnhanced(inv);
  else if(act==='pdfPublic') downloadPublicPDFEnhanced(inv);
  else if(act==='csvPublic') downloadPublicCSVEnhanced(inv);
});

// Wire new UI: override some button listeners to enhanced functions
window.addEventListener('load', ()=>{
  // load products from storage and render
  loadProductsFromStorage();
  renderCatalog();
  // replace public refresh handler if exists
  const pr = document.getElementById('btnPublicRefresh'); if(pr){ pr.removeEventListener && pr.removeEventListener('click', loadPublicInvoices); pr.addEventListener('click', loadPublicInvoicesEnhanced); }
  // also hook initial public load
  const pubSearch = document.getElementById('publicSearch'); if(pubSearch){ pubSearch.addEventListener('keyup', (e)=>{ if(e.key==='Enter') loadPublicInvoicesEnhanced(); }); }
  // override Save button in modal to enhanced save
  const modalSave = document.getElementById('btnModalSave'); if(modalSave){ modalSave.removeEventListener && modalSave.removeEventListener('click', saveProductFromModal); modalSave.addEventListener('click', saveProductFromModalEnhanced); }
});
</script>

</body></html>`);
    w.document.close();
  }catch(e){ alert('Error: '+e.message); }
}

/* Print and Export */
function printInvoice(){ const content = $('invoicePreview').outerHTML; const styles = `<style>@media print{@page{size:auto;margin:10mm}}body{font-family:Inter,Arial;color:#0f172a;margin:12px}.invoice{padding:0}.small{font-size:13px;color:#6b7280}#lineItems>div{display:flex;justify-content:space-between;padding:6px 0}</style>`; const w = window.open('','_blank'); const title = $('invoiceNo').innerText || 'Invoice'; w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>${title}</title>${styles}</head><body>${content}
<!-- Enhancement script: product edit/delete, public invoice actions, mobile popup fallback -->
<script>
// --- Persistence for products ---
function loadProductsFromStorage(){
  try{
    const raw = localStorage.getItem('products_v1');
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length) {
        products = arr.map(p=>({id:p.id,name:p.name,price:p.price,sku:p.sku}));
      }
    }
  }catch(e){ console.warn('loadProducts error', e); }
}
function saveProductsToStorage(){
  try{ localStorage.setItem('products_v1', JSON.stringify(products)); }catch(e){console.warn('saveProducts error', e);}
}

// Override renderCatalog to include Edit/Delete buttons for products
function renderCatalog(filter=''){
  const el = document.getElementById('productCatalog'); el.innerHTML = '';
  const q = (filter||'').toLowerCase();
  const list = products.filter(p => (p.name||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));
  list.forEach(p => {
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.name}</strong><div class='small'>₹ ${Number(p.price||0).toFixed(2)}${p.sku?(' • '+p.sku):''}</div>`;
    const right = document.createElement('div');
    // Add, Edit, Delete buttons
    const btnAdd = document.createElement('button'); btnAdd.className='btn'; btnAdd.textContent='Add'; btnAdd.addEventListener('click', ()=>addToCart(p.id));
    const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.style.background='#f59e0b'; btnEdit.textContent='Edit'; btnEdit.addEventListener('click', ()=>openEditProductModal(p.id));
    const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.style.background='#ef4444'; btnDel.textContent='Delete'; btnDel.addEventListener('click', ()=>deleteProduct(p.id));
    // layout
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='6px'; wrap.appendChild(btnAdd); wrap.appendChild(btnEdit); wrap.appendChild(btnDel);
    right.appendChild(wrap);
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.appendChild(left); row.appendChild(right);
    d.appendChild(row); el.appendChild(d);
  });
}

// Product edit modal support: reuse the existing modal but indicate edit mode
let editingProductId = null;
function openEditProductModal(id){
  const p = products.find(x=>x.id===id); if(!p) return alert('Product not found');
  editingProductId = id;
  document.getElementById('p_name').value = p.name;
  document.getElementById('p_price').value = p.price;
  document.getElementById('p_sku').value = p.sku||'';
  document.getElementById('modal').style.display='flex';
}
function saveProductFromModalEnhanced(){
  const name = document.getElementById('p_name').value.trim();
  const price = Number(document.getElementById('p_price').value)||0;
  const sku = document.getElementById('p_sku').value.trim();
  if(!name || price<=0){ alert('Enter product name and price > 0'); return; }
  if(editingProductId){
    const p = products.find(x=>x.id===editingProductId);
    if(p){ p.name = name; p.price = price; p.sku = sku; }
    editingProductId = null;
  } else {
    const id = products.length? (Math.max(...products.map(p=>p.id))+1):1;
    products.push({id,name,price,sku});
  }
  saveProductsToStorage();
  closeAddProductModal();
  renderCatalog();
}

// delete product
function deleteProduct(id){
  if(!confirm('Delete product? This will remove it from the catalog.')) return;
  products = products.filter(p=>p.id!==id);
  saveProductsToStorage();
  renderCatalog();
}

// --- Mobile-friendly window open fallback ---
function openWindowWithContent(html, filenameForBlob = null) {
  try {
    const w = window.open('', '_blank');
    if (w && w.document) {
      w.document.open();
      w.document.write(html);
      w.document.close();
      return w;
    }
  } catch (e) {
    console.warn('window.open failed, falling back to blob:', e);
  }
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  if (filenameForBlob) a.download = filenameForBlob;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 10000);
  return null;
}

// --- Public invoices: view/edit/delete/pdf/csv ---
async function loadPublicInvoicesEnhanced(){
  const container = document.getElementById('publicList'); container.innerHTML = '<div class="small">Loading...</div>';
  if (!firestore) { container.innerHTML = '<div class="small">Firebase not configured — public invoices unavailable.</div>'; return; }
  try {
    const snapshot = await firestore.collection('public_invoices').orderBy('publishedAt','desc').limit(200).get();
    const q = document.getElementById('publicSearch').value.trim().toLowerCase();
    const list = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (!q || (data.customer && data.customer.mobile && data.customer.mobile.includes(q)) || (data.invoiceNo && data.invoiceNo.toLowerCase().includes(q))) list.push(data);
    });
    if (!list.length) { container.innerHTML = '<div class="small">No public invoices found.</div>'; return; }
    container.innerHTML = '';
    list.forEach(r => {
      const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${r.invoiceNo}</strong> <span class='small'>• ${new Date(r.date).toLocaleString()}</span>
            <div class='small'>${r.customer && r.customer.name ? r.customer.name+' • '+r.customer.mobile : 'No customer'}</div>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='viewPublic'>View</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='editPublic'>Edit</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='deletePublic'>Delete</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='pdfPublic'>PDF</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='csvPublic'>Excel</button>
          </div>
        </div>`;
      container.appendChild(d);
    });
  } catch (e) {
    console.error(e); container.innerHTML = '<div class="small">Error loading public invoices: '+e.message+'</div>';
  }
}

async function viewPublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const html = renderPrintableHtmlForInvoice(r);
    const w = openWindowWithContent(html);
    if (w && w.document) {
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e) { console.warn('print failed', e); } }, 250);
    } else {
      alert('Invoice opened. Use your browser menu -> Print -> Save as PDF to create a PDF.');
    }
  } catch (e) { alert('Error: ' + e.message); }
}

async function editPublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    cart = r.products.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku}));
    settings.discount = r.settings?.discount || 0;
    settings.discountType = r.settings?.discountType || 'flat';
    settings.tax = r.settings?.tax || 0;
    settings.advance = r.settings?.advance || 0;
    document.getElementById('discount').value = settings.discount; document.getElementById('discountType').value = settings.discountType; document.getElementById('tax').value = settings.tax;
    document.getElementById('advanceInput').value = settings.advance;
    document.getElementById('customerName').value = r.customer?.name || '';
    document.getElementById('customerMobile').value = r.customer?.mobile || '';
    document.getElementById('invoiceNo').innerText = r.invoiceNo;
    renderCart();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    alert('Public invoice loaded into editor. Make changes and Save & Publish to overwrite (if your rules allow).');
  } catch (e) { alert('Error: ' + e.message); }
}

async function deletePublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  if (!confirm('Delete public invoice '+invNo+'? This removes it from the public list.')) return;
  try {
    await firestore.collection('public_invoices').doc(invNo).delete();
    alert('Public invoice deleted.');
    loadPublicInvoicesEnhanced();
  } catch (e) { alert('Delete failed: '+e.message); }
}

async function downloadPublicPDFEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const html = renderPrintableHtmlForInvoice(r);
    const w = openWindowWithContent(html, `invoice-${invNo}.html`);
    if (w && w.document) {
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e){ console.warn(e); } }, 300);
    } else {
      alert('Invoice opened. Use your browser menu -> Print -> Save as PDF to create a PDF.');
    }
  } catch (e) { alert('Error: '+e.message); }
}

async function downloadPublicCSVEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const rows = [];
    rows.push(['Invoice', r.invoiceNo]);
    rows.push(['Date', new Date(r.date).toLocaleString()]);
    rows.push(['Customer', r.customer?.name || '', 'Mobile', r.customer?.mobile || '']);
    rows.push([]);
    rows.push(['Item','Qty','Unit Price','Total']);
    r.products.forEach(p => { rows.push([p.name, p.qty, p.price.toFixed(2), (p.price * p.qty).toFixed(2)]); });
    rows.push([]);
    const totals = r.totals || {};
    rows.push(['Subtotal', totals.subtotal?.toFixed(2) || '0.00']);
    rows.push(['Tax', totals.tax?.toFixed(2) || '0.00']);
    rows.push(['Total', totals.total?.toFixed(2) || '0.00']);
    rows.push(['Advance', totals.advance?.toFixed(2) || '0.00']);
    rows.push(['Balance', totals.balance?.toFixed(2) || '0.00']);
    const csv = rows.map(rw => rw.map(cell => { if (cell === null || cell === undefined) return ''; const s = String(cell).replace(/"/g, '""'); return `"${s}"`; }).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `invoice-${invNo}.csv`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),10000);
  } catch (e) { alert('Error: '+e.message); }
}

// helper to produce printable HTML for an invoice object (reused)
function renderPrintableHtmlForInvoice(r) {
  const itemsHtml = (r.products || []).map(p => `<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${p.name} x ${p.qty}</div><div>₹ ${(p.price*p.qty).toFixed(2)}</div></div>`).join('');
  const totals = r.totals || {};
  return `<!doctype html><html><head><meta charset="utf-8"><title>${r.invoiceNo}</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:12px}h2{margin:0 0 8px} .small{color:#666;font-size:13px}</style>
    </head><body>
    <h2>Invoice: ${r.invoiceNo}</h2>
    <div class="small">${new Date(r.date).toLocaleString()}</div>
    <div style="margin-top:8px">${r.customer?.name || ''} ${r.customer?.mobile ? ' • ' + r.customer.mobile : ''}</div>
    <hr/>
    ${itemsHtml}
    <hr/>
    <div style="text-align:right">
      <div>Subtotal: ₹ ${(totals.subtotal||0).toFixed(2)}</div>
      <div>Tax: ₹ ${(totals.tax||0).toFixed(2)}</div>
      <div style="font-weight:700">Total: ₹ ${(totals.total||0).toFixed(2)}</div>
      <div>Advance: ₹ ${(totals.advance||0).toFixed(2)}</div>
      <div style="font-size:18px;margin-top:6px">Balance: ₹ ${(totals.balance||0).toFixed(2)}</div>
    </div>
    </body></html>`;
}

// Delegated public action handler
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const inv = btn.dataset.inv; const act = btn.dataset.action;
  if(act==='viewPublic') viewPublicInvoiceEnhanced(inv);
  else if(act==='editPublic') editPublicInvoiceEnhanced(inv);
  else if(act==='deletePublic') deletePublicInvoiceEnhanced(inv);
  else if(act==='pdfPublic') downloadPublicPDFEnhanced(inv);
  else if(act==='csvPublic') downloadPublicCSVEnhanced(inv);
});

// Wire new UI: override some button listeners to enhanced functions
window.addEventListener('load', ()=>{
  // load products from storage and render
  loadProductsFromStorage();
  renderCatalog();
  // replace public refresh handler if exists
  const pr = document.getElementById('btnPublicRefresh'); if(pr){ pr.removeEventListener && pr.removeEventListener('click', loadPublicInvoices); pr.addEventListener('click', loadPublicInvoicesEnhanced); }
  // also hook initial public load
  const pubSearch = document.getElementById('publicSearch'); if(pubSearch){ pubSearch.addEventListener('keyup', (e)=>{ if(e.key==='Enter') loadPublicInvoicesEnhanced(); }); }
  // override Save button in modal to enhanced save
  const modalSave = document.getElementById('btnModalSave'); if(modalSave){ modalSave.removeEventListener && modalSave.removeEventListener('click', saveProductFromModal); modalSave.addEventListener('click', saveProductFromModalEnhanced); }
});
</script>

</body></html>`); w.document.close(); w.focus(); w.onload = ()=> setTimeout(()=> w.print(),100); }
function exportInvoice(){ const data = { invoiceNo:$('invoiceNo').innerText, date:new Date().toISOString(), customer:{name:$('customerName').value.trim(), mobile:$('customerMobile').value.trim()}, products:cart, settings}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`invoice-${$('invoiceNo').innerText||'untitled'}.json`; a.click(); }

/* Add product modal handlers */
function openAddProductModal(){ $('modal').style.display='flex'; }
function closeAddProductModal(){ $('modal').style.display='none'; $('p_name').value=''; $('p_price').value=''; $('p_sku').value=''; }
function saveProductFromModal(){ const name = $('p_name').value.trim(); const price = Number($('p_price').value)||0; const sku = $('p_sku').value.trim(); if(!name || price<=0){ alert('Enter product name and price > 0'); return; } const id = products.length? (Math.max(...products.map(p=>p.id))+1):1; products.push({id,name,price,sku}); closeAddProductModal(); renderCatalog(); }

/* Init */
function randomizeInvoice(){ const n = 'INV'+Date.now().toString().slice(-8); $('invoiceNo').innerText=n; $('previewInv').innerText=n; }
function applySettings(){ settings.discount = Number($('discount').value)||0; settings.discountType = $('discountType').value; settings.tax = Number($('tax').value)||0; settings.advance = Number($('advanceInput').value)||0; renderPreview(); }

function init(){
  renderCatalog(); renderCart(); randomizeInvoice();
  $('search').addEventListener('input', e=> renderCatalog(e.target.value));
  $('btnAddProduct').addEventListener('click', openAddProductModal);
  $('btnModalCancel').addEventListener('click', closeAddProductModal);
  $('btnModalSave').addEventListener('click', saveProductFromModal);
  $('btnClear').addEventListener('click', clearCart);
  $('btnPrint').addEventListener('click', printInvoice);
  $('btnExport').addEventListener('click', exportInvoice);
  $('btnSaveLocal').addEventListener('click', saveInvoice);
  $('publishBtn').addEventListener('click', saveAndPublish);
  $('btnHistory').addEventListener('click', openHistory);
  $('btnCloseHistory').addEventListener('click', closeHistory);
  $('btnSearchHistory').addEventListener('click', searchHistory);
  $('btnListAll').addEventListener('click', listAllHistory);
  $('btnApply').addEventListener('click', ()=>{ applySettings(); alert('Settings applied.'); });
  $('btnNewInv').addEventListener('click', randomizeInvoice);
  $('btnPublicRefresh').addEventListener('click', loadPublicInvoices);
  $('advanceInput').addEventListener('input', ()=>{ settings.advance = Number($('advanceInput').value)||0; renderPreview(); });
  $('publishBtn').disabled = false;
}

init();
</script>

<!-- Enhancement script: product edit/delete, public invoice actions, mobile popup fallback -->
<script>
// --- Persistence for products ---
function loadProductsFromStorage(){
  try{
    const raw = localStorage.getItem('products_v1');
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length) {
        products = arr.map(p=>({id:p.id,name:p.name,price:p.price,sku:p.sku}));
      }
    }
  }catch(e){ console.warn('loadProducts error', e); }
}
function saveProductsToStorage(){
  try{ localStorage.setItem('products_v1', JSON.stringify(products)); }catch(e){console.warn('saveProducts error', e);}
}

// Override renderCatalog to include Edit/Delete buttons for products
function renderCatalog(filter=''){
  const el = document.getElementById('productCatalog'); el.innerHTML = '';
  const q = (filter||'').toLowerCase();
  const list = products.filter(p => (p.name||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));
  list.forEach(p => {
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
    const left = document.createElement('div'); left.innerHTML = `<strong>${p.name}</strong><div class='small'>₹ ${Number(p.price||0).toFixed(2)}${p.sku?(' • '+p.sku):''}</div>`;
    const right = document.createElement('div');
    // Add, Edit, Delete buttons
    const btnAdd = document.createElement('button'); btnAdd.className='btn'; btnAdd.textContent='Add'; btnAdd.addEventListener('click', ()=>addToCart(p.id));
    const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.style.background='#f59e0b'; btnEdit.textContent='Edit'; btnEdit.addEventListener('click', ()=>openEditProductModal(p.id));
    const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.style.background='#ef4444'; btnDel.textContent='Delete'; btnDel.addEventListener('click', ()=>deleteProduct(p.id));
    // layout
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='6px'; wrap.appendChild(btnAdd); wrap.appendChild(btnEdit); wrap.appendChild(btnDel);
    right.appendChild(wrap);
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.appendChild(left); row.appendChild(right);
    d.appendChild(row); el.appendChild(d);
  });
}

// Product edit modal support: reuse the existing modal but indicate edit mode
let editingProductId = null;
function openEditProductModal(id){
  const p = products.find(x=>x.id===id); if(!p) return alert('Product not found');
  editingProductId = id;
  document.getElementById('p_name').value = p.name;
  document.getElementById('p_price').value = p.price;
  document.getElementById('p_sku').value = p.sku||'';
  document.getElementById('modal').style.display='flex';
}
function saveProductFromModalEnhanced(){
  const name = document.getElementById('p_name').value.trim();
  const price = Number(document.getElementById('p_price').value)||0;
  const sku = document.getElementById('p_sku').value.trim();
  if(!name || price<=0){ alert('Enter product name and price > 0'); return; }
  if(editingProductId){
    const p = products.find(x=>x.id===editingProductId);
    if(p){ p.name = name; p.price = price; p.sku = sku; }
    editingProductId = null;
  } else {
    const id = products.length? (Math.max(...products.map(p=>p.id))+1):1;
    products.push({id,name,price,sku});
  }
  saveProductsToStorage();
  closeAddProductModal();
  renderCatalog();
}

// delete product
function deleteProduct(id){
  if(!confirm('Delete product? This will remove it from the catalog.')) return;
  products = products.filter(p=>p.id!==id);
  saveProductsToStorage();
  renderCatalog();
}

// --- Mobile-friendly window open fallback ---
function openWindowWithContent(html, filenameForBlob = null) {
  try {
    const w = window.open('', '_blank');
    if (w && w.document) {
      w.document.open();
      w.document.write(html);
      w.document.close();
      return w;
    }
  } catch (e) {
    console.warn('window.open failed, falling back to blob:', e);
  }
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  if (filenameForBlob) a.download = filenameForBlob;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 10000);
  return null;
}

// --- Public invoices: view/edit/delete/pdf/csv ---
async function loadPublicInvoicesEnhanced(){
  const container = document.getElementById('publicList'); container.innerHTML = '<div class="small">Loading...</div>';
  if (!firestore) { container.innerHTML = '<div class="small">Firebase not configured — public invoices unavailable.</div>'; return; }
  try {
    const snapshot = await firestore.collection('public_invoices').orderBy('publishedAt','desc').limit(200).get();
    const q = document.getElementById('publicSearch').value.trim().toLowerCase();
    const list = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (!q || (data.customer && data.customer.mobile && data.customer.mobile.includes(q)) || (data.invoiceNo && data.invoiceNo.toLowerCase().includes(q))) list.push(data);
    });
    if (!list.length) { container.innerHTML = '<div class="small">No public invoices found.</div>'; return; }
    container.innerHTML = '';
    list.forEach(r => {
      const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9';
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${r.invoiceNo}</strong> <span class='small'>• ${new Date(r.date).toLocaleString()}</span>
            <div class='small'>${r.customer && r.customer.name ? r.customer.name+' • '+r.customer.mobile : 'No customer'}</div>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='viewPublic'>View</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='editPublic'>Edit</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='deletePublic'>Delete</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='pdfPublic'>PDF</button>
            <button class='btn' data-inv='${r.invoiceNo}' data-action='csvPublic'>Excel</button>
          </div>
        </div>`;
      container.appendChild(d);
    });
  } catch (e) {
    console.error(e); container.innerHTML = '<div class="small">Error loading public invoices: '+e.message+'</div>';
  }
}

async function viewPublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const html = renderPrintableHtmlForInvoice(r);
    const w = openWindowWithContent(html);
    if (w && w.document) {
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e) { console.warn('print failed', e); } }, 250);
    } else {
      alert('Invoice opened. Use your browser menu -> Print -> Save as PDF to create a PDF.');
    }
  } catch (e) { alert('Error: ' + e.message); }
}

async function editPublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    cart = r.products.map(p=>({id:p.id,name:p.name,price:p.price,qty:p.qty,sku:p.sku}));
    settings.discount = r.settings?.discount || 0;
    settings.discountType = r.settings?.discountType || 'flat';
    settings.tax = r.settings?.tax || 0;
    settings.advance = r.settings?.advance || 0;
    document.getElementById('discount').value = settings.discount; document.getElementById('discountType').value = settings.discountType; document.getElementById('tax').value = settings.tax;
    document.getElementById('advanceInput').value = settings.advance;
    document.getElementById('customerName').value = r.customer?.name || '';
    document.getElementById('customerMobile').value = r.customer?.mobile || '';
    document.getElementById('invoiceNo').innerText = r.invoiceNo;
    renderCart();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    alert('Public invoice loaded into editor. Make changes and Save & Publish to overwrite (if your rules allow).');
  } catch (e) { alert('Error: ' + e.message); }
}

async function deletePublicInvoiceEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  if (!confirm('Delete public invoice '+invNo+'? This removes it from the public list.')) return;
  try {
    await firestore.collection('public_invoices').doc(invNo).delete();
    alert('Public invoice deleted.');
    loadPublicInvoicesEnhanced();
  } catch (e) { alert('Delete failed: '+e.message); }
}

async function downloadPublicPDFEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const html = renderPrintableHtmlForInvoice(r);
    const w = openWindowWithContent(html, `invoice-${invNo}.html`);
    if (w && w.document) {
      setTimeout(()=>{ try { w.focus(); w.print(); } catch(e){ console.warn(e); } }, 300);
    } else {
      alert('Invoice opened. Use your browser menu -> Print -> Save as PDF to create a PDF.');
    }
  } catch (e) { alert('Error: '+e.message); }
}

async function downloadPublicCSVEnhanced(invNo){
  if (!firestore) { alert('Firebase not configured'); return; }
  try {
    const doc = await firestore.collection('public_invoices').doc(invNo).get();
    if (!doc.exists) { alert('Not found'); return; }
    const r = doc.data();
    const rows = [];
    rows.push(['Invoice', r.invoiceNo]);
    rows.push(['Date', new Date(r.date).toLocaleString()]);
    rows.push(['Customer', r.customer?.name || '', 'Mobile', r.customer?.mobile || '']);
    rows.push([]);
    rows.push(['Item','Qty','Unit Price','Total']);
    r.products.forEach(p => { rows.push([p.name, p.qty, p.price.toFixed(2), (p.price * p.qty).toFixed(2)]); });
    rows.push([]);
    const totals = r.totals || {};
    rows.push(['Subtotal', totals.subtotal?.toFixed(2) || '0.00']);
    rows.push(['Tax', totals.tax?.toFixed(2) || '0.00']);
    rows.push(['Total', totals.total?.toFixed(2) || '0.00']);
    rows.push(['Advance', totals.advance?.toFixed(2) || '0.00']);
    rows.push(['Balance', totals.balance?.toFixed(2) || '0.00']);
    const csv = rows.map(rw => rw.map(cell => { if (cell === null || cell === undefined) return ''; const s = String(cell).replace(/"/g, '""'); return `"${s}"`; }).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `invoice-${invNo}.csv`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),10000);
  } catch (e) { alert('Error: '+e.message); }
}

// helper to produce printable HTML for an invoice object (reused)
function renderPrintableHtmlForInvoice(r) {
  const itemsHtml = (r.products || []).map(p => `<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${p.name} x ${p.qty}</div><div>₹ ${(p.price*p.qty).toFixed(2)}</div></div>`).join('');
  const totals = r.totals || {};
  return `<!doctype html><html><head><meta charset="utf-8"><title>${r.invoiceNo}</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:12px}h2{margin:0 0 8px} .small{color:#666;font-size:13px}</style>
    </head><body>
    <h2>Invoice: ${r.invoiceNo}</h2>
    <div class="small">${new Date(r.date).toLocaleString()}</div>
    <div style="margin-top:8px">${r.customer?.name || ''} ${r.customer?.mobile ? ' • ' + r.customer.mobile : ''}</div>
    <hr/>
    ${itemsHtml}
    <hr/>
    <div style="text-align:right">
      <div>Subtotal: ₹ ${(totals.subtotal||0).toFixed(2)}</div>
      <div>Tax: ₹ ${(totals.tax||0).toFixed(2)}</div>
      <div style="font-weight:700">Total: ₹ ${(totals.total||0).toFixed(2)}</div>
      <div>Advance: ₹ ${(totals.advance||0).toFixed(2)}</div>
      <div style="font-size:18px;margin-top:6px">Balance: ₹ ${(totals.balance||0).toFixed(2)}</div>
    </div>
    </body></html>`;
}

// Delegated public action handler
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const inv = btn.dataset.inv; const act = btn.dataset.action;
  if(act==='viewPublic') viewPublicInvoiceEnhanced(inv);
  else if(act==='editPublic') editPublicInvoiceEnhanced(inv);
  else if(act==='deletePublic') deletePublicInvoiceEnhanced(inv);
  else if(act==='pdfPublic') downloadPublicPDFEnhanced(inv);
  else if(act==='csvPublic') downloadPublicCSVEnhanced(inv);
});

// Wire new UI: override some button listeners to enhanced functions
window.addEventListener('load', ()=>{
  // load products from storage and render
  loadProductsFromStorage();
  renderCatalog();
  // replace public refresh handler if exists
  const pr = document.getElementById('btnPublicRefresh'); if(pr){ pr.removeEventListener && pr.removeEventListener('click', loadPublicInvoices); pr.addEventListener('click', loadPublicInvoicesEnhanced); }
  // also hook initial public load
  const pubSearch = document.getElementById('publicSearch'); if(pubSearch){ pubSearch.addEventListener('keyup', (e)=>{ if(e.key==='Enter') loadPublicInvoicesEnhanced(); }); }
  // override Save button in modal to enhanced save
  const modalSave = document.getElementById('btnModalSave'); if(modalSave){ modalSave.removeEventListener && modalSave.removeEventListener('click', saveProductFromModal); modalSave.addEventListener('click', saveProductFromModalEnhanced); }
});
</script>

</body>
</html>
